<!DOCTYPE html>
<html>
<head>
    <title>Bill Layne Insurance - COI Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.7/download.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        button {
            background-color: #0066cc;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0052a3;
        }
        .email-section {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        .email-button {
            background-color: #4caf50;
            margin-top: 10px;
        }
        .email-button:hover {
            background-color: #45a049;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        .instructions {
            background-color: #fffbf0;
            border: 1px solid #f0ad4e;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .section-title {
            background: #0066cc;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .template-selector {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .email-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .email-options button {
            flex: 1;
        }
        
        /* Autocomplete styles */
        .autocomplete-wrapper {
            position: relative;
        }
        .template-search {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #0066cc;
            border-radius: 5px;
            background-color: #fff;
        }
        .template-search:focus {
            outline: none;
            border-color: #0052a3;
            box-shadow: 0 0 5px rgba(0,102,204,0.3);
        }
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #0066cc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        .suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion:hover {
            background-color: #f0f8ff;
        }
        .suggestion.selected {
            background-color: #e3f2fd;
        }
        .suggestion-match {
            background-color: #ffeb3b;
            font-weight: bold;
        }
        .no-results {
            padding: 10px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h2 style="color: #0066cc; margin: 0;">BILL LAYNE INSURANCE AGENCY</h2>
            <p style="margin: 5px 0; color: #666;">1283 N Bridge St, Elkin NC 28621 â€¢ (336) 835-1993</p>
        </div>
        
        <h1>Certificate of Insurance Generator</h1>
        
        <div class="instructions">
            <strong>ðŸ“‹ Quick Instructions:</strong><br>
            1. Type to search for a template (e.g., type "pipe" to find Pipe Connection)<br>
            2. Fill in the certificate holder information<br>
            3. Add email address to send copy to holder<br>
            4. Click "Generate Certificate"<br>
            5. Use email buttons to send to client
        </div>

        <form id="coiForm">
            <div class="template-selector">
                <label for="templateSearch" style="font-size: 18px; color: #0066cc;">
                    Search or Select Certificate Template:
                </label>
                <div class="autocomplete-wrapper">
                    <input type="text" 
                           id="templateSearch" 
                           class="template-search" 
                           placeholder="Start typing client name (e.g., 'pipe' or 'burch')"
                           autocomplete="off">
                    <div id="suggestions" class="suggestions"></div>
                </div>
                <input type="hidden" id="selectedTemplate" required>
                
                <div style="margin-top: 10px;">
                    <select id="templateSelect" style="width: 100%; padding: 10px;">
                        <option value="">-- Or select from dropdown --</option>
                        <option value="blank.pdf">Blank Certificate</option>
                        <option value="burchette.pdf">Burchette & Burchette Hardwood Floors</option>
                        <option value="panic.pdf">Panic Plumbing LLC</option>
                        <option value="topnotch.pdf">Top Notch Plumbing</option>
                    </select>
                </div>
            </div>

            <div class="section-title">Certificate Holder Information</div>

            <div class="form-group">
                <label for="holderName">Certificate Holder Name:</label>
                <input type="text" id="holderName" placeholder="Example: ABC Construction Company" required>
            </div>

            <div class="form-group">
                <label for="holderEmail">Certificate Holder Email: (Optional)</label>
                <input type="email" id="holderEmail" placeholder="client@example.com">
            </div>

            <div class="form-group">
                <label for="address">Street Address:</label>
                <input type="text" id="address" placeholder="Example: 123 Main Street" required>
            </div>

            <div class="form-group">
                <label for="city">City:</label>
                <input type="text" id="city" placeholder="Example: Winston-Salem" required>
            </div>

            <div class="form-group">
                <label for="state">State (2 letters):</label>
                <input type="text" id="state" maxlength="2" placeholder="NC" required style="text-transform: uppercase;">
            </div>

            <div class="form-group">
                <label for="zip">ZIP Code:</label>
                <input type="text" id="zip" placeholder="27101" required>
            </div>

            <div class="section-title">Additional Information (Optional)</div>
            
            <div class="form-group">
                <label for="description">Description of Operations / Additional Insured:</label>
                <textarea id="description" placeholder="Example: WISHON CARTER BUILDERS INC..."></textarea>
            </div>

            <button type="submit" id="generateBtn">Generate Certificate</button>
        </form>

        <div id="success" class="success">
            âœ… Certificate generated successfully! Check your Downloads folder.
        </div>

        <div id="emailSection" class="email-section">
            <h3 style="margin-top: 0;">ðŸ“§ Email Options</h3>
            <p>Certificate generated for: <strong id="generatedFor"></strong></p>
            
            <div class="email-options">
                <button onclick="openEmailClient()" class="email-button">
                    ðŸ“§ Open Email Program
                </button>
                <button onclick="copyEmailTemplate()" class="email-button">
                    ðŸ“‹ Copy Email Template
                </button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                <small>
                    <strong>Note:</strong> After clicking "Open Email Program", attach the downloaded PDF from your Downloads folder.
                </small>
            </div>
        </div>
    </div>

    <script>
    // Configuration
    const GITHUB_USERNAME = 'BillLayne';
    const REPO_NAME = 'coi-generator';
    const TEMPLATE_PATH = 'pdfs/templates';
    
    // Template database - ADD ALL YOUR TEMPLATES HERE
    const templates = [
        { file: 'blank.pdf', name: 'Blank Certificate', keywords: ['blank', 'empty', 'template'] },
        { file: 'burchette.pdf', name: 'Burchette & Burchette Hardwood Floors', keywords: ['burchette', 'hardwood', 'floors', 'wood'] },
        { file: 'panic.pdf', name: 'Panic Plumbing LLC', keywords: ['panic', 'plumbing', 'plumber', 'water'] },
        { file: 'topnotch.pdf', name: 'Top Notch Plumbing', keywords: ['top', 'notch', 'plumbing', 'plumber'] },
        // Add more templates here as you get new clients:
        // { file: 'pipeconnection.pdf', name: 'Pipe Connection Services', keywords: ['pipe', 'connection', 'piping'] },
        // { file: 'smithroofing.pdf', name: 'Smith Roofing Company', keywords: ['smith', 'roofing', 'roof'] },
    ];
    
    // Store last generated info for email
    let lastGeneratedInfo = {
        holderName: '',
        holderEmail: '',
        fileName: '',
        dateStr: ''
    };
    
    // Autocomplete functionality
    let selectedIndex = -1;
    
    function searchTemplates(query) {
        if (!query) return [];
        
        const searchTerm = query.toLowerCase();
        return templates.filter(template => {
            // Check if name contains search term
            if (template.name.toLowerCase().includes(searchTerm)) return true;
            // Check if any keyword matches
            return template.keywords.some(keyword => keyword.includes(searchTerm));
        });
    }
    
    function highlightMatch(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="suggestion-match">$1</span>');
    }
    
    function showSuggestions(results, query) {
        const suggestionsDiv = document.getElementById('suggestions');
        
        if (results.length === 0 && query) {
            suggestionsDiv.innerHTML = '<div class="no-results">No templates found. You can add the filename manually.</div>';
            suggestionsDiv.style.display = 'block';
            return;
        }
        
        if (results.length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        suggestionsDiv.innerHTML = results.map((template, index) => 
            `<div class="suggestion" data-index="${index}" data-file="${template.file}">
                ${highlightMatch(template.name, query)}
            </div>`
        ).join('');
        
        suggestionsDiv.style.display = 'block';
        selectedIndex = -1;
    }
    
    // Search input handler
    document.getElementById('templateSearch').addEventListener('input', function(e) {
        const query = e.target.value;
        const results = searchTemplates(query);
        showSuggestions(results, query);
        
        // Clear dropdown when searching
        document.getElementById('templateSelect').value = '';
        document.getElementById('selectedTemplate').value = '';
    });
    
    // Handle suggestion clicks
    document.getElementById('suggestions').addEventListener('click', function(e) {
        const suggestion = e.target.closest('.suggestion');
        if (suggestion) {
            const file = suggestion.dataset.file;
            const template = templates.find(t => t.file === file);
            
            document.getElementById('templateSearch').value = template.name;
            document.getElementById('selectedTemplate').value = file;
            document.getElementById('suggestions').style.display = 'none';
            document.getElementById('templateSelect').value = '';
        }
    });
    
    // Handle keyboard navigation
    document.getElementById('templateSearch').addEventListener('keydown', function(e) {
        const suggestions = document.querySelectorAll('.suggestion');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
            updateSelection(suggestions);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(suggestions);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            suggestions[selectedIndex].click();
        } else if (e.key === 'Escape') {
            document.getElementById('suggestions').style.display = 'none';
        }
    });
    
    function updateSelection(suggestions) {
        suggestions.forEach((s, i) => {
            if (i === selectedIndex) {
                s.classList.add('selected');
            } else {
                s.classList.remove('selected');
            }
        });
    }
    
    // Handle dropdown selection
    document.getElementById('templateSelect').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('selectedTemplate').value = this.value;
            document.getElementById('templateSearch').value = '';
            document.getElementById('suggestions').style.display = 'none';
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-wrapper')) {
            document.getElementById('suggestions').style.display = 'none';
        }
    });
    
    // Get template URL
    const getTemplateUrl = (filename) => {
        return `https://${GITHUB_USERNAME}.github.io/${REPO_NAME}/${TEMPLATE_PATH}/${filename}`;
    };
    
    // Email functions
    function openEmailClient() {
        const subject = encodeURIComponent(`Certificate of Insurance - ${lastGeneratedInfo.holderName}`);
        const body = encodeURIComponent(
            `Dear ${lastGeneratedInfo.holderName},\n\n` +
            `Please find attached your Certificate of Insurance dated ${lastGeneratedInfo.dateStr}.\n\n` +
            `This certificate is provided for your records and confirms your insurance coverage as specified.\n\n` +
            `If you have any questions or need additional information, please don't hesitate to contact us.\n\n` +
            `Best regards,\n` +
            `Bill Layne Insurance Agency\n` +
            `1283 N Bridge St, Elkin NC 28621\n` +
            `Phone: (336) 835-1993\n` +
            `Email: Save@BillLayneInsurance.com`
        );
        
        const mailto = `mailto:${lastGeneratedInfo.holderEmail}?subject=${subject}&body=${body}`;
        window.open(mailto);
    }
    
    function copyEmailTemplate() {
        const template = 
            `To: ${lastGeneratedInfo.holderEmail}\n` +
            `Subject: Certificate of Insurance - ${lastGeneratedInfo.holderName}\n\n` +
            `Dear ${lastGeneratedInfo.holderName},\n\n` +
            `Please find attached your Certificate of Insurance dated ${lastGeneratedInfo.dateStr}.\n\n` +
            `This certificate is provided for your records and confirms your insurance coverage as specified.\n\n` +
            `If you have any questions or need additional information, please don't hesitate to contact us.\n\n` +
            `Best regards,\n` +
            `Bill Layne Insurance Agency\n` +
            `1283 N Bridge St, Elkin NC 28621\n` +
            `Phone: (336) 835-1993\n` +
            `Email: Save@BillLayneInsurance.com\n\n` +
            `[Remember to attach: ${lastGeneratedInfo.fileName}]`;
        
        navigator.clipboard.writeText(template).then(() => {
            alert('Email template copied to clipboard! Paste it into your email program and attach the PDF.');
        });
    }
    
    // Make state uppercase
    document.getElementById('state').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
    
    // Handle form submission
    document.getElementById('coiForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // Get template from either search or dropdown
        let templateFile = document.getElementById('selectedTemplate').value || 
                          document.getElementById('templateSelect').value;
        
        // If user typed a custom filename in search box
        if (!templateFile && document.getElementById('templateSearch').value) {
            const customName = document.getElementById('templateSearch').value;
            if (customName.includes('.pdf')) {
                templateFile = customName;
            } else {
                templateFile = customName + '.pdf';
            }
        }
        
        if (!templateFile) {
            alert('Please select or enter a template');
            return;
        }
        
        try {
            const templateUrl = getTemplateUrl(templateFile);
            const response = await fetch(templateUrl);
            
            if (!response.ok) {
                throw new Error('Template not found. Make sure the file is uploaded to GitHub.');
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            const pages = pdfDoc.getPages();
            const firstPage = pages[0];
            
            const helveticaFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            const helveticaBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
            
            // Get form data
            const holderName = document.getElementById('holderName').value.toUpperCase();
            const holderEmail = document.getElementById('holderEmail').value;
            const address = document.getElementById('address').value.toUpperCase();
            const city = document.getElementById('city').value.toUpperCase();
            const state = document.getElementById('state').value.toUpperCase();
            const zip = document.getElementById('zip').value;
            const description = document.getElementById('description').value.toUpperCase();
            
            // Date
            const today = new Date();
            const dateStr = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                           today.getDate().toString().padStart(2, '0') + '/' + 
                           today.getFullYear();
            
            // Add text to PDF
            firstPage.drawText(dateStr, {
                x: 520,
                y: 750,
                size: 10,
                font: helveticaFont,
                color: PDFLib.rgb(0, 0, 0)
            });
            
            firstPage.drawText(holderName, {
                x: 60,
                y: 115,
                size: 10,
                font: helveticaBold,
                color: PDFLib.rgb(0, 0, 0)
            });
            
            firstPage.drawText(address, {
                x: 60,
                y: 100,
                size: 10,
                font: helveticaFont,
                color: PDFLib.rgb(0, 0, 0)
            });
            
            firstPage.drawText(`${city}, ${state} ${zip}`, {
                x: 60,
                y: 85,
                size: 10,
                font: helveticaFont,
                color: PDFLib.rgb(0, 0, 0)
            });
            
            // Description
            if (description && description.trim() !== '') {
                const maxWidth = 450;
                const fontSize = 9;
                const words = description.split(' ');
                const lines = [];
                let currentLine = '';
                
                for (const word of words) {
                    const testLine = currentLine ? `${currentLine} ${word}` : word;
                    const width = helveticaFont.widthOfTextAtSize(testLine, fontSize);
                    
                    if (width > maxWidth && currentLine) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                }
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                let yPosition = 210;
                for (const line of lines) {
                    firstPage.drawText(line, {
                        x: 60,
                        y: yPosition,
                        size: fontSize,
                        font: helveticaFont,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    yPosition -= 12;
                    if (yPosition < 170) break;
                }
            }
            
            // Generate PDF
            const pdfBytes = await pdfDoc.save();
            const holderNameClean = holderName.replace(/[^a-z0-9]/gi, '_');
            const fileName = `COI_${holderNameClean}_${dateStr.replace(/\//g, '-')}.pdf`;
            
            // Store info for email
            lastGeneratedInfo = {
                holderName: holderName,
                holderEmail: holderEmail || 'client@email.com',
                fileName: fileName,
                dateStr: dateStr
            };
            
            // Download
            download(pdfBytes, fileName, "application/pdf");
            
            // Show success and email options
            document.getElementById('success').style.display = 'block';
            document.getElementById('generatedFor').textContent = holderName;
            document.getElementById('emailSection').style.display = 'block';
            
            // Reset form
            document.getElementById('holderName').value = '';
            document.getElementById('holderEmail').value = '';
            document.getElementById('address').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('zip').value = '';
            document.getElementById('description').value = '';
            document.getElementById('templateSearch').value = '';
            document.getElementById('selectedTemplate').value = '';
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
    </script>
</body>
</html>
